{% extends 'layout.html' %}

{% block title %}Panel de Administración{% endblock %}

{% block content %}

<style>
.admin-card {
  transition: transform 0.2s, box-shadow 0.2s;
  height: 100%;
}

.admin-card:hover {
  transform: translateY(-5px);
  box-shadow: 0 8px 25px rgba(108, 85, 249, 0.3);
}

.admin-icon {
  font-size: 2.5rem;
  margin-bottom: 1rem;
  color: #6C55F9;
}

.stats-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
  gap: 20px;
  margin-bottom: 30px;
}

.stat-card {
  padding: 20px;
  border-radius: 10px;
  text-align: center;
}

.stat-number {
  font-size: 2rem;
  font-weight: bold;
  color: #6C55F9;
}

.quick-actions {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 15px;
}

.action-btn {
  padding: 15px;
  text-align: center;
  border-radius: 8px;
  text-decoration: none;
  transition: all 0.3s;
  display: block;
}

.action-btn:hover {
  text-decoration: none;
  transform: scale(1.05);
}

/* Modo oscuro */
.table {
  color: inherit;
}

.table-hover tbody tr:hover {
  background-color: rgba(108, 85, 249, 0.1);
}

.badge-warning {
  background-color: #FAC14D !important;
  color: #343531 !important;
}

.badge-success {
  background-color: #35bb78 !important;
}

.badge-primary {
  background-color: #6C55F9 !important;
}
</style>

<div class="page-banner home-banner" style="height:200px">
  <div class="container h-100">
    <div class="row align-items-center h-100">     
      <div class="col-lg-12 text-center">
        <h1 class="mb-3">🛠️ Panel de Administración</h1>
        <p class="text-lg">Centro de control y gestión del sistema</p>
      </div>
    </div>
  </div>
</div>

<main>
  <div class="page-section">
    <div class="container">
      
      <!-- Estadísticas del Sistema -->
      <div class="row mb-5">
        <div class="col-12">
          <h3 class="mb-4">📊 Estadísticas del Sistema</h3>
          <div class="stats-grid">
            <div class="card stat-card">
              <div class="stat-number">{{ stats.users }}</div>
              <div>👥 Usuarios Registrados</div>
            </div>
            <div class="card stat-card">
              <div class="stat-number">{{ stats.posts }}</div>
              <div>📝 Posts del Blog</div>
            </div>
            <div class="card stat-card">
              <div class="stat-number">{{ stats.files }}</div>
              <div>📁 Archivos Subidos</div>
            </div>
            <div class="card stat-card">
              <div class="stat-number">{{ stats.uptime }}</div>
              <div>⏱️ Tiempo Activo</div>
            </div>
          </div>
        </div>
      </div>

      <!-- Acciones Rápidas -->
      <div class="row mb-5">
        <div class="col-12">
          <h3 class="mb-4">⚡ Acciones Rápidas</h3>
          <div class="quick-actions">
            <a href="/admin/logger" class="action-btn btn btn-info">
              📋 Ver Logs
            </a>
            <a href="/admin/users" class="action-btn btn btn-primary">
              👥 Gestionar Usuarios
            </a>
            <a href="/admin/content" class="action-btn btn btn-success">
              📝 Gestionar Contenido
            </a>
            <a href="/admin/system" class="action-btn btn btn-warning">
              ⚙️ Configuración
            </a>
            <a href="/admin/backup" class="action-btn btn btn-success">
              💾 Respaldos
            </a>
            <a href="/admin/monitor" class="action-btn btn btn-secondary">
              📈 Monitoreo
            </a>
            <a href="/admin/maintenance" class="action-btn btn btn-dark">
              🔧 Mantenimiento
            </a>
          </div>
        </div>
      </div>

      <!-- Herramientas de Sistema -->
      <div class="row">
        <div class="col-md-6 mb-4">
          <div class="card admin-card">
            <div class="card-header">
              <h5>🔄 Control del Servidor</h5>
            </div>
            <div class="card-body text-center">
              <p>Gestión del estado del servidor</p>
              <div class="btn-group" role="group">
                <a href="/reboot" class="btn btn-warning btn-sm">🔄 Reiniciar</a>
                <a href="/poweroff" class="btn btn-danger btn-sm">🔌 Apagar</a>
              </div>
            </div>
          </div>
        </div>

        <div class="col-md-6 mb-4">
          <div class="card admin-card">
            <div class="card-header">
              <h5>🗄️ Base de Datos</h5>
            </div>
            <div class="card-body text-center">
              <p>Estado: <span class="badge badge-{{ 'success' if db_status else 'danger' }}">
                {{ 'Conectada' if db_status else 'Error' }}
              </span></p>
              <a href="/admin/database" class="btn btn-primary btn-sm">Gestionar BD</a>
            </div>
          </div>
        </div>

        <div class="col-md-12 mb-4">
          <div class="card admin-card">
            <div class="card-header">
              <h5>📊 Recursos del Sistema</h5>
            </div>
            <div class="card-body">
              <div class="row">
                <div class="col-md-6">
                  <div class="mb-2">
                    <small>Espacio en Disco:</small>
                    <div class="progress">
                      <div class="progress-bar" style="width: {{ disk_usage }}%">{{ disk_usage }}%</div>
                    </div>
                  </div>
                  <div class="mb-2">
                    <small>Memoria RAM:</small>
                    <div class="progress">
                      <div class="progress-bar bg-warning" style="width: {{ memory_usage }}%">{{ memory_usage }}%</div>
                    </div>
                  </div>
                </div>
                <div class="col-md-6">
                  <div class="mb-2">
                    <small>Sistema Operativo:</small>
                    <div><strong id="osName">{{ stats.os_name or 'Cargando...' }}</strong></div>
                  </div>
                  <div class="mb-2">
                    <small>Versión Python:</small>
                    <div><strong id="pythonVersion">{{ stats.python_version or 'Cargando...' }}</strong></div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="col-md-6 mb-4">
          <div class="card admin-card">
            <div class="card-header">
              <h5>🔐 Seguridad</h5>
            </div>
            <div class="card-body">
              <div id="securityInfo">Cargando...</div>
            </div>
          </div>
        </div>
        
        <div class="col-md-6 mb-4">
          <div class="card admin-card">
            <div class="card-header">
              <h5>🌐 Información de Red</h5>
            </div>
            <div class="card-body">
              <div id="networkInfo">Cargando...</div>
            </div>
          </div>
        </div>
      </div>

      <!-- Widgets Funcionales -->
      <div class="row mb-4">
        <div class="col-md-4">
          <div class="card">
            <div class="card-header">
              <h5>👥 Usuarios Activos Hoy</h5>
            </div>
            <div class="card-body">
              <div id="activeUsers">Cargando...</div>
            </div>
          </div>
        </div>
        <div class="col-md-4">
          <div class="card">
            <div class="card-header">
              <h5>📁 Archivos Recientes</h5>
            </div>
            <div class="card-body">
              <div id="recentFiles">Cargando...</div>
            </div>
          </div>
        </div>
        <div class="col-md-4">
          <div class="card">
            <div class="card-header">
              <h5>📊 Actividad del Sistema</h5>
            </div>
            <div class="card-body">
              <div id="systemActivity">Cargando...</div>
            </div>
          </div>
        </div>
      </div>

      <!-- Herramientas de Mantenimiento -->
      <div class="row mb-4">
        <div class="col-md-4">
          <div class="card">
            <div class="card-header">
              <h5>🧹 Limpieza</h5>
            </div>
            <div class="card-body text-center">
              <button class="btn btn-warning" onclick="cleanupFiles()">🗑️ Limpiar Archivos Temporales</button>
              <div id="cleanupResult" class="mt-2"></div>
            </div>
          </div>
        </div>
        <div class="col-md-4">
          <div class="card">
            <div class="card-header">
              <h5>💾 Backup</h5>
            </div>
            <div class="card-body text-center">
              <button class="btn btn-success" onclick="createBackup()">📦 Crear Backup</button>
              <div id="backupResult" class="mt-2"></div>
            </div>
          </div>
        </div>
        <div class="col-md-4">
          <div class="card">
            <div class="card-header">
              <h5>📊 Estadísticas</h5>
            </div>
            <div class="card-body text-center">
              <button class="btn btn-info" onclick="generateReport()">📈 Generar Reporte</button>
              <div id="reportResult" class="mt-2"></div>
            </div>
          </div>
        </div>
      </div>

      <!-- Posts Populares -->
      <div class="row">
        <div class="col-12">
          <div class="card">
            <div class="card-header">
              <h5>🔥 Posts Más Populares</h5>
            </div>
            <div class="card-body">
              <div id="popularPosts">Cargando...</div>
            </div>
          </div>
        </div>
      </div>

    </div>
  </div>
</main>

<script>
// Actualizar métricas principales
function updateDashboard() {
  fetch('/admin/dashboard/metrics')
    .then(response => response.json())
    .then(data => {
      if (data.error) {
        console.error('Error en métricas:', data.error);
        return;
      }
      
      // Actualizar estadísticas principales
      const stats = document.querySelectorAll('.stat-number');
      if (stats[0]) stats[0].textContent = data.users || 0;
      if (stats[1]) stats[1].textContent = data.posts || 0;
      if (stats[2]) stats[2].textContent = data.files || 0;
      if (stats[3]) stats[3].textContent = data.uptime || '0h 0m';
      
      // Actualizar barras de progreso con validación
      const diskBar = document.querySelector('.progress-bar');
      const memoryBar = document.querySelectorAll('.progress-bar')[1];
      
      if (diskBar && typeof data.disk_usage === 'number') {
        const diskUsage = Math.min(100, Math.max(0, data.disk_usage));
        diskBar.style.width = diskUsage + '%';
        diskBar.textContent = diskUsage.toFixed(1) + '%';
      }
      
      if (memoryBar && typeof data.memory_usage === 'number') {
        const memoryUsage = Math.min(100, Math.max(0, data.memory_usage));
        memoryBar.style.width = memoryUsage + '%';
        memoryBar.textContent = memoryUsage.toFixed(1) + '%';
        
        // Cambiar color según el uso de memoria
        memoryBar.className = 'progress-bar';
        if (memoryUsage > 80) {
          memoryBar.classList.add('bg-danger');
        } else if (memoryUsage > 60) {
          memoryBar.classList.add('bg-warning');
        } else {
          memoryBar.classList.add('bg-success');
        }
      }
    })
    .catch(error => {
      console.error('Error actualizando dashboard:', error);
      // Mostrar indicador de error en la interfaz
      const stats = document.querySelectorAll('.stat-number');
      stats.forEach(stat => {
        if (stat.textContent === 'undefined' || stat.textContent === 'NaN') {
          stat.textContent = 'Error';
        }
      });
    });
}

// Cargar widgets adicionales
function loadActiveUsers() {
  fetch('/admin/dashboard/active-users')
    .then(response => response.json())
    .then(data => {
      const html = data.users.slice(0, 5).map(user => 
        `<div class="mb-1">
          <strong>${user.username}</strong>
          <small class="text-muted d-block">${user.last_seen}</small>
        </div>`
      ).join('');
      document.getElementById('activeUsers').innerHTML = html || '<p class="text-muted">No hay usuarios activos</p>';
    })
    .catch(() => document.getElementById('activeUsers').innerHTML = '<p class="text-danger">Error cargando datos</p>');
}

function loadRecentFiles() {
  fetch('/admin/dashboard/recent-files')
    .then(response => response.json())
    .then(data => {
      const html = data.files.slice(0, 5).map(file => 
        `<div class="mb-1">
          <strong>${file.name.length > 20 ? file.name.substring(0, 20) + '...' : file.name}</strong>
          <small class="text-muted d-block">por ${file.user}</small>
        </div>`
      ).join('');
      document.getElementById('recentFiles').innerHTML = html || '<p class="text-muted">No hay archivos recientes</p>';
    })
    .catch(() => document.getElementById('recentFiles').innerHTML = '<p class="text-danger">Error cargando datos</p>');
}

function loadPopularPosts() {
  fetch('/admin/dashboard/popular-posts')
    .then(response => response.json())
    .then(data => {
      const html = data.posts.map((post, index) => 
        `<div class="mb-2 d-flex justify-content-between align-items-center">
          <div>
            <span class="badge badge-secondary mr-2">#${index + 1}</span>
            <strong>${post.title.length > 40 ? post.title.substring(0, 40) + '...' : post.title}</strong>
            <small class="text-muted d-block">por ${post.author} • ${post.date || 'Sin fecha'}</small>
          </div>
          <div class="text-right">
            <span class="badge badge-primary">${post.views} 👁️</span>
            <small class="text-muted d-block">${post.comments || 0} 💬</small>
          </div>
        </div>`
      ).join('');
      document.getElementById('popularPosts').innerHTML = html || '<p class="text-muted">No hay posts disponibles</p>';
    })
    .catch(() => document.getElementById('popularPosts').innerHTML = '<p class="text-danger">Error cargando datos</p>');
}

function loadSecurityInfo() {
  fetch('/admin/dashboard/security')
    .then(response => response.json())
    .then(data => {
      const html = `
        <small class="text-muted">Usuarios verificados:</small>
        <div class="mb-2"><strong>${data.verified_users}%</strong></div>
        <small class="text-muted">Sesiones activas:</small>
        <div class="mb-2"><strong>${data.active_sessions}</strong></div>
        <small class="text-muted">Intentos fallidos hoy:</small>
        <div class="mb-2"><strong class="text-danger">${data.failed_logins}</strong></div>
        <small class="text-muted">Último acceso admin:</small>
        <div><strong>${data.last_admin_access}</strong></div>
      `;
      document.getElementById('securityInfo').innerHTML = html;
    })
    .catch(() => document.getElementById('securityInfo').innerHTML = 'Error cargando datos');
}

function loadSystemActivity() {
  fetch('/admin/dashboard/metrics')
    .then(response => response.json())
    .then(data => {
      const processCpu = Math.min(100, Math.max(0, data.process_cpu || 0));
      const processMemory = data.process_memory || 0;
      
      const html = `
        <div class="mb-2">
          <small class="text-muted">CPU del proceso Flask:</small>
          <div class="progress progress-sm">
            <div class="progress-bar bg-info" style="width: ${processCpu}%">${processCpu.toFixed(1)}%</div>
          </div>
        </div>
        <div class="mb-2">
          <small class="text-muted">RAM del proceso Flask:</small>
          <div><strong>${processMemory.toFixed(1)} MB</strong></div>
        </div>
        <div class="mb-2">
          <small class="text-muted">Threads activos:</small>
          <div><strong>${data.threads_count || 0}</strong></div>
        </div>
        <div class="mb-2">
          <small class="text-muted">Conexiones de red:</small>
          <div><strong>${data.network_connections || 0}</strong></div>
        </div>
      `;
      document.getElementById('systemActivity').innerHTML = html;
      
      // Actualizar info del sistema (solo si no está ya establecida)
      const osElement = document.getElementById('osName');
      const pythonElement = document.getElementById('pythonVersion');
      
      if (data.os_name && (osElement.textContent === 'Cargando...' || osElement.textContent === 'Error')) {
        osElement.textContent = data.os_name;
      }
      if (data.python_version && (pythonElement.textContent === 'Cargando...' || pythonElement.textContent === 'Error')) {
        pythonElement.textContent = data.python_version;
      }
    })
    .catch(() => {
      document.getElementById('systemActivity').innerHTML = '<p class="text-danger">Error cargando datos del sistema</p>';
    });
}

function loadNetworkInfo() {
  fetch('/admin/dashboard/metrics')
    .then(response => response.json())
    .then(data => {
      const html = `
        <div class="mb-2">
          <small class="text-muted">Hostname:</small>
          <div><strong>${data.hostname || 'Desconocido'}</strong></div>
        </div>
        <div class="mb-2">
          <small class="text-muted">IP Local:</small>
          <div><strong>${data.local_ip || 'No disponible'}</strong></div>
        </div>
        <div class="mb-2">
          <small class="text-muted">IP Externa:</small>
          <div><strong>${data.external_ip || 'No disponible'}</strong></div>
        </div>
        <div class="mb-2">
          <small class="text-muted">Puerto:</small>
          <div><strong>9001</strong></div>
        </div>
      `;
      document.getElementById('networkInfo').innerHTML = html;
    })
    .catch(() => document.getElementById('networkInfo').innerHTML = 'Error cargando datos');
}

function cleanupFiles() {
  document.getElementById('cleanupResult').innerHTML = '<small class="text-info">Limpiando...</small>';
  fetch('/admin/dashboard/cleanup', {method: 'POST'})
    .then(response => response.json())
    .then(data => {
      document.getElementById('cleanupResult').innerHTML = 
        `<small class="text-success">✅ ${data.message}</small>`;
    })
    .catch(() => {
      document.getElementById('cleanupResult').innerHTML = 
        '<small class="text-danger">❌ Error</small>';
    });
}

function createBackup() {
  document.getElementById('backupResult').innerHTML = '<small class="text-info">Creando backup...</small>';
  fetch('/admin/dashboard/backup', {method: 'POST'})
    .then(response => response.json())
    .then(data => {
      document.getElementById('backupResult').innerHTML = 
        `<small class="text-success">✅ ${data.message}</small>`;
    })
    .catch(() => {
      document.getElementById('backupResult').innerHTML = 
        '<small class="text-danger">❌ Error</small>';
    });
}

function generateReport() {
  document.getElementById('reportResult').innerHTML = '<small class="text-info">Generando...</small>';
  fetch('/admin/dashboard/report', {
    method: 'GET'
  })
    .then(response => {
      if (response.ok) {
        return response.blob();
      }
      return response.json().then(data => {
        throw new Error(data.error || 'Error desconocido');
      });
    })
    .then(blob => {
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `reporte_${new Date().toISOString().split('T')[0]}.txt`;
      a.click();
      window.URL.revokeObjectURL(url);
      document.getElementById('reportResult').innerHTML = 
        '<small class="text-success">✅ Descargado</small>';
    })
    .catch(error => {
      console.error('Error generando reporte:', error);
      document.getElementById('reportResult').innerHTML = 
        '<small class="text-danger">❌ Error: ' + error.message + '</small>';
    });
}

// Variables para controlar las actualizaciones
let updateCount = 0;

// Actualizar con diferentes frecuencias
setInterval(() => {
  updateCount++;
  
  // Actualizar métricas básicas cada 30 segundos
  updateDashboard();
  loadSystemActivity();
  
  // Actualizar datos menos críticos cada 2 minutos (cada 4 ciclos)
  if (updateCount % 4 === 0) {
    loadActiveUsers();
    loadRecentFiles();
    loadSecurityInfo();
    loadNetworkInfo();
  }
  
  // Actualizar posts populares cada 5 minutos (cada 10 ciclos)
  if (updateCount % 10 === 0) {
    loadPopularPosts();
  }
}, 30000);

// Actualizar al cargar
document.addEventListener('DOMContentLoaded', () => {
  updateDashboard();
  loadActiveUsers();
  loadRecentFiles();
  loadPopularPosts();
  loadSecurityInfo();
  loadSystemActivity();
  loadNetworkInfo();
});
</script>

{% endblock %}