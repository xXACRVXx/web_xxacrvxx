{% extends 'layout.html' %}

{% block title %}Gestión de Backups{% endblock %}

{% block content %}

<div class="page-banner home-banner" style="height:200px">
  <div class="container h-100">
    <div class="row align-items-center h-100">     
      <div class="col-lg-8 py-2">
        <h1 class="mb-3">💾 Gestión de Backups</h1>
        <p class="text-lg mb-4">Crear y gestionar copias de seguridad</p>
        <a href="/admin/dashboard" class="btn btn-outline-primary">← Volver al Dashboard</a>
      </div>
    </div>
  </div>
</div>

<main>
  <div class="page-section">
    <div class="container">
      
      <div class="row mb-4">
        <div class="col-md-4">
          <div class="card">
            <div class="card-header">
              <h5>📦 Crear Backup</h5>
            </div>
            <div class="card-body">
              <p>Generar copia de seguridad completa en formato JSON</p>
              <button class="btn btn-success" onclick="createBackup()">💾 Crear Backup</button>
              <div id="backupResult" class="mt-3"></div>
            </div>
          </div>
        </div>
        <div class="col-md-4">
          <div class="card">
            <div class="card-header">
              <h5>📥 Restaurar Backup</h5>
            </div>
            <div class="card-body">
              <p>Restaurar datos desde archivo JSON</p>
              <input type="file" id="restoreFile" accept=".json" class="form-control mb-2">
              <button class="btn btn-warning" onclick="restoreBackup()">🔄 Restaurar</button>
              <div id="restoreResult" class="mt-3"></div>
            </div>
          </div>
        </div>
        <div class="col-md-4">
          <div class="card">
            <div class="card-header">
              <h5>📊 Generar Reporte</h5>
            </div>
            <div class="card-body">
              <p>Descargar reporte detallado del sistema</p>
              <button class="btn btn-info" onclick="generateReport()">📈 Generar Reporte</button>
              <div id="reportResult" class="mt-3"></div>
            </div>
          </div>
        </div>
      </div>

      <!-- Lista de Backups -->
      <div class="row mb-4">
        <div class="col-12">
          <div class="card">
            <div class="card-header d-flex justify-content-between">
              <h5>📋 Backups Disponibles</h5>
              <button class="btn btn-sm btn-secondary" onclick="loadBackupList()">🔄 Actualizar</button>
            </div>
            <div class="card-body">
              <div id="backupList">Cargando...</div>
            </div>
          </div>
        </div>
      </div>

      <div class="row">
        <div class="col-12">
          <div class="card">
            <div class="card-header">
              <h5>📋 Información del Sistema</h5>
            </div>
            <div class="card-body">
              <div class="row">
                <div class="col-md-4">
                  <strong>Usuarios:</strong> <span id="userCount">-</span><br>
                  <strong>Posts:</strong> <span id="postCount">-</span><br>
                  <strong>Archivos:</strong> <span id="fileCount">-</span>
                </div>
                <div class="col-md-4">
                  <strong>Tiempo activo:</strong> <span id="uptime">-</span><br>
                  <strong>Memoria:</strong> <span id="memory">-</span><br>
                  <strong>Disco:</strong> <span id="disk">-</span>
                </div>
                <div class="col-md-4">
                  <strong>Última actualización:</strong><br>
                  <span id="lastUpdate">-</span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

    </div>
  </div>
</main>

<script>
function createBackup() {
  document.getElementById('backupResult').innerHTML = '<div class="alert alert-info">🔄 Creando backup...</div>';
  fetch('/admin/dashboard/backup', {method: 'POST'})
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        document.getElementById('backupResult').innerHTML = 
          `<div class="alert alert-success">✅ ${data.message}</div>`;
        loadBackupList(); // Actualizar lista
      } else {
        document.getElementById('backupResult').innerHTML = 
          `<div class="alert alert-danger">❌ Error: ${data.error}</div>`;
      }
    })
    .catch(() => {
      document.getElementById('backupResult').innerHTML = 
        '<div class="alert alert-danger">❌ Error de conexión</div>';
    });
}

function restoreBackup() {
  const fileInput = document.getElementById('restoreFile');
  if (!fileInput.files[0]) {
    document.getElementById('restoreResult').innerHTML = 
      '<div class="alert alert-warning">⚠️ Selecciona un archivo JSON</div>';
    return;
  }
  
  if (!confirm('⚠️ ADVERTENCIA: Esta acción puede sobrescribir datos existentes.\n\n¿Estás seguro de continuar?')) {
    return;
  }
  
  const formData = new FormData();
  formData.append('file', fileInput.files[0]);
  
  document.getElementById('restoreResult').innerHTML = '<div class="alert alert-info">🔄 Restaurando backup...</div>';
  
  fetch('/admin/backup/restore', {
    method: 'POST',
    body: formData
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      document.getElementById('restoreResult').innerHTML = 
        `<div class="alert alert-success">✅ ${data.message}<br><small>Usuarios: ${data.details?.users || 0}, Posts: ${data.details?.posts || 0}</small></div>`;
      updateStats(); // Actualizar estadísticas
    } else {
      document.getElementById('restoreResult').innerHTML = 
        `<div class="alert alert-danger">❌ Error: ${data.error}</div>`;
    }
  })
  .catch(() => {
    document.getElementById('restoreResult').innerHTML = 
      '<div class="alert alert-danger">❌ Error de conexión</div>';
  });
}

function loadBackupList() {
  document.getElementById('backupList').innerHTML = 'Cargando...';
  fetch('/admin/backup/list')
    .then(response => response.json())
    .then(data => {
      if (data.backups && data.backups.length > 0) {
        let html = '<div class="table-responsive"><table class="table table-sm"><thead><tr><th>Archivo</th><th>Fecha</th><th>Tamaño</th><th>Datos</th><th>Acciones</th></tr></thead><tbody>';
        
        data.backups.forEach(backup => {
          const sizeKB = (backup.size / 1024).toFixed(1);
          html += `
            <tr>
              <td><code>${backup.filename}</code></td>
              <td>${backup.created}</td>
              <td>${sizeKB} KB</td>
              <td><small>${backup.users} usuarios, ${backup.posts} posts</small></td>
              <td>
                <button class="btn btn-sm btn-primary" onclick="downloadBackup('${backup.filename}')">📥 Descargar</button>
                <button class="btn btn-sm btn-danger" onclick="deleteBackup('${backup.filename}')">🗑️ Eliminar</button>
              </td>
            </tr>
          `;
        });
        
        html += '</tbody></table></div>';
        document.getElementById('backupList').innerHTML = html;
      } else {
        document.getElementById('backupList').innerHTML = '<p class="text-muted">No hay backups disponibles</p>';
      }
    })
    .catch(() => {
      document.getElementById('backupList').innerHTML = '<p class="text-danger">Error cargando lista de backups</p>';
    });
}

function downloadBackup(filename) {
  window.open(`/admin/backup/download/${filename}`, '_blank');
}

function deleteBackup(filename) {
  if (!confirm(`¿Eliminar el backup "${filename}"?\n\nEsta acción no se puede deshacer.`)) {
    return;
  }
  
  fetch(`/admin/backup/delete/${filename}`, {
    method: 'DELETE',
    headers: {
      'Content-Type': 'application/json',
      'X-CSRFToken': '{{ csrf_token() }}'
    }
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      alert('✅ Backup eliminado correctamente');
      loadBackupList(); // Actualizar lista
    } else {
      alert('❌ Error: ' + data.error);
    }
  })
  .catch(() => {
    alert('❌ Error de conexión');
  });
}

function generateReport() {
  document.getElementById('reportResult').innerHTML = '<div class="alert alert-info">📊 Generando reporte...</div>';
  fetch('/admin/dashboard/report')
    .then(response => {
      if (response.ok) {
        return response.blob();
      }
      throw new Error('Error en la respuesta');
    })
    .then(blob => {
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `reporte_${new Date().toISOString().split('T')[0]}.txt`;
      a.click();
      window.URL.revokeObjectURL(url);
      document.getElementById('reportResult').innerHTML = 
        '<div class="alert alert-success">✅ Reporte descargado</div>';
    })
    .catch(() => {
      document.getElementById('reportResult').innerHTML = 
        '<div class="alert alert-danger">❌ Error generando reporte</div>';
    });
}

function updateStats() {
  fetch('/admin/dashboard/metrics')
    .then(response => response.json())
    .then(data => {
      document.getElementById('userCount').textContent = data.users || 0;
      document.getElementById('postCount').textContent = data.posts || 0;
      document.getElementById('fileCount').textContent = data.files || 0;
      document.getElementById('uptime').textContent = data.uptime || '0h 0m';
      document.getElementById('memory').textContent = (data.memory_usage || 0).toFixed(1) + '%';
      document.getElementById('disk').textContent = (data.disk_usage || 0).toFixed(1) + '%';
      document.getElementById('lastUpdate').textContent = new Date().toLocaleString();
    })
    .catch(() => {
      document.getElementById('lastUpdate').textContent = 'Error cargando datos';
    });
}

// Actualizar cada 30 segundos
setInterval(updateStats, 30000);
document.addEventListener('DOMContentLoaded', () => {
  updateStats();
  loadBackupList();
});
</script>

{% endblock %}