{% extends 'layout.html' %}

{% block head %}
  {% for post in the_post %}
    <link rel="canonical" href="https://xxacrvxx.ydns.eu/blog/{{ post['title'] }}" />
  {% endfor %}
{% endblock %}

{% block title %}
  {% for post in the_post %}
    {{ post['title'] }}
  {% endfor %}
{% endblock %}

{% block content %}
<style>
/* Mejoras para modo oscuro */
[data-bs-theme="dark"] .card {
  background-color: var(--bs-dark) !important;
  border-color: var(--bs-border-color) !important;
}

[data-bs-theme="dark"] .text-body {
  color: var(--bs-body-color) !important;
}

[data-bs-theme="dark"] .border-bottom {
  border-color: var(--bs-border-color) !important;
}

[data-bs-theme="dark"] .alert-info {
  background-color: rgba(13, 110, 253, 0.15) !important;
  border-color: rgba(13, 110, 253, 0.3) !important;
  color: var(--bs-body-color) !important;
}

[data-bs-theme="dark"] .form-control {
  background-color: var(--bs-dark) !important;
  border-color: var(--bs-border-color) !important;
  color: var(--bs-body-color) !important;
}

[data-bs-theme="dark"] .form-control:focus {
  background-color: var(--bs-dark) !important;
  border-color: var(--bs-primary) !important;
  color: var(--bs-body-color) !important;
}

.comment-item {
  transition: background-color 0.2s ease;
}

.comment-item:hover {
  background-color: rgba(0,0,0,0.02);
}

[data-bs-theme="dark"] .comment-item:hover {
  background-color: rgba(255,255,255,0.05);
}

[data-bs-theme="dark"] .card-header h5,
[data-bs-theme="dark"] .card-header h3 {
  color: var(--bs-body-color) !important;
}

[data-bs-theme="dark"] a {
  color: var(--bs-link-color) !important;
}

[data-bs-theme="dark"] .btn-group .btn {
  margin-right: 4px;
}

/* Estilos para contenido del post */
.post-content {
  word-wrap: break-word;
  overflow-wrap: break-word;
}

.post-content img {
  max-width: 100%;
  height: auto;
  border-radius: 8px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.1);
  margin: 15px 0;
  display: block;
  cursor: pointer;
  transition: transform 0.3s ease, box-shadow 0.3s ease;
}

.post-content img:hover {
  transform: scale(1.02);
  box-shadow: 0 8px 25px rgba(0,0,0,0.15);
}

.post-content video {
  max-width: 100%;
  height: auto;
  border-radius: 8px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.1);
  margin: 15px 0;
  display: block;
}

/* Modal para previsualización de medios */
.media-modal {
  display: none;
  position: fixed;
  z-index: 9999;
  left: 0;
  top: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(0,0,0,0.9);
  backdrop-filter: blur(5px);
}

.media-modal-content {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  max-width: 90vw;
  max-height: 90vh;
  border-radius: 8px;
  box-shadow: 0 20px 60px rgba(0,0,0,0.5);
}

.media-modal img,
.media-modal video {
  width: 100%;
  height: auto;
  border-radius: 8px;
}

.media-modal-close {
  position: absolute;
  top: -40px;
  right: 0;
  color: white;
  font-size: 28px;
  font-weight: bold;
  cursor: pointer;
  background: rgba(0,0,0,0.5);
  border-radius: 50%;
  width: 35px;
  height: 35px;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: background 0.3s;
}

.media-modal-close:hover {
  background: rgba(255,255,255,0.2);
}

/* Estilos de código - Fondo oscuro por defecto */
.post-content pre {
  background-color: #0d1117;
  border: 1px solid #30363d;
  border-radius: 8px;
  padding: 20px;
  overflow-x: auto;
  font-family: 'Fira Code', 'Cascadia Code', 'JetBrains Mono', Consolas, 'Courier New', monospace;
  font-size: 14px;
  line-height: 1.6;
  margin: 24px 0;
  position: relative;
  box-shadow: 0 2px 8px rgba(0,0,0,0.3);
  word-wrap: break-word;
  white-space: pre-wrap;
}

.post-content code {
  background-color: rgba(110, 118, 129, 0.3);
  color: #f78c6c;
  padding: 3px 6px;
  border-radius: 4px;
  font-family: 'Fira Code', 'Cascadia Code', 'JetBrains Mono', Consolas, 'Courier New', monospace;
  font-size: 0.9em;
  font-weight: 500;
}

.post-content pre code {
  background-color: transparent;
  color: #e6edf3;
  padding: 0;
  border-radius: 0;
  font-size: 14px;
  font-weight: 400;
  white-space: pre-wrap;
  word-break: break-word;
}

/* Resaltado de sintaxis - VSCode Dark+ theme */
.post-content pre code .keyword { color: #569cd6; font-weight: 600; }
.post-content pre code .string { color: #ce9178; }
.post-content pre code .comment { color: #6a9955; font-style: italic; }
.post-content pre code .number { color: #b5cea8; }
.post-content pre code .function { color: #dcdcaa; }
.post-content pre code .variable { color: #9cdcfe; }
.post-content pre code .operator { color: #d4d4d4; }
.post-content pre code .tag { color: #569cd6; }
.post-content pre code .attribute { color: #92c5f8; }
.post-content pre code .value { color: #ce9178; }
.post-content pre code .type { color: #4ec9b0; }
.post-content pre code .class { color: #4ec9b0; }
.post-content pre code .method { color: #dcdcaa; }
.post-content pre code .property { color: #9cdcfe; }

.post-content blockquote {
  border-left: 4px solid #6c55f9;
  padding-left: 20px;
  margin: 20px 0;
  font-style: italic;
  background-color: rgba(108, 85, 249, 0.05);
  padding: 15px 20px;
  border-radius: 0 6px 6px 0;
}

.post-content table {
  width: 100%;
  border-collapse: collapse;
  margin: 20px 0;
  border: 1px solid #dee2e6;
  border-radius: 6px;
  overflow: hidden;
}

.post-content th,
.post-content td {
  padding: 12px;
  text-align: left;
  border-bottom: 1px solid #dee2e6;
}

.post-content th {
  background-color: #f8f9fa;
  font-weight: 600;
}

.post-content ul,
.post-content ol {
  padding-left: 25px;
  margin: 15px 0;
}

.post-content li {
  margin-bottom: 8px;
}

.post-content h1,
.post-content h2,
.post-content h3,
.post-content h4,
.post-content h5,
.post-content h6 {
  margin-top: 30px;
  margin-bottom: 15px;
  font-weight: 600;
  color: var(--bs-body-color);
}

.post-content h1 { font-size: 2rem; }
.post-content h2 { font-size: 1.75rem; }
.post-content h3 { font-size: 1.5rem; }
.post-content h4 { font-size: 1.25rem; }
.post-content h5 { font-size: 1.1rem; }
.post-content h6 { font-size: 1rem; }

.post-content p {
  margin-bottom: 16px;
  line-height: 1.7;
}

.post-content a {
  color: #6c55f9;
  text-decoration: none;
  border-bottom: 1px solid transparent;
  transition: border-color 0.2s;
}

.post-content a:hover {
  border-bottom-color: #6c55f9;
}

/* Modo claro - Mantener fondo oscuro pero ajustar inline code */
[data-bs-theme="light"] .post-content code {
  background-color: rgba(175, 184, 193, 0.2);
  color: #d73a49;
}

[data-bs-theme="dark"] .post-content blockquote {
  background-color: rgba(108, 85, 249, 0.1);
  color: var(--bs-body-color);
}

[data-bs-theme="dark"] .post-content table {
  border-color: #4a5568;
}

[data-bs-theme="dark"] .post-content th {
  background-color: #2d3748;
  color: var(--bs-body-color);
}

[data-bs-theme="dark"] .post-content th,
[data-bs-theme="dark"] .post-content td {
  border-color: #4a5568;
  color: var(--bs-body-color);
}

[data-bs-theme="dark"] .post-content img {
  box-shadow: 0 4px 12px rgba(0,0,0,0.5);
}

[data-bs-theme="dark"] .post-content img:hover {
  box-shadow: 0 8px 25px rgba(0,0,0,0.7);
}

[data-bs-theme="dark"] .post-content video {
  box-shadow: 0 4px 12px rgba(0,0,0,0.5);
}

/* Responsive */
@media (max-width: 768px) {
  .post-content img {
    margin: 10px 0;
  }
  
  .post-content pre {
    padding: 16px;
    font-size: 13px;
    margin: 16px 0;
    border-radius: 6px;
  }
  
  .post-content pre code {
    font-size: 13px;
  }
  
  .post-content code {
    font-size: 0.85em;
    padding: 2px 4px;
  }
  
  .post-content table {
    font-size: 14px;
  }
  
  .post-content th,
  .post-content td {
    padding: 8px;
  }
  
  /* Botones de comentarios responsive */
  .d-flex.justify-content-between {
    flex-direction: column;
    gap: 15px;
  }
  
  .d-flex.justify-content-between .btn {
    width: 100%;
    margin-bottom: 8px;
  }
  
  .d-flex.justify-content-between .btn:last-child {
    margin-bottom: 0;
  }
  
  .d-flex.justify-content-between small {
    text-align: center;
    margin-top: 5px;
  }
}

@media (max-width: 480px) {
  .post-content pre {
    padding: 12px;
    font-size: 12px;
    overflow-x: scroll;
  }
  
  .post-content pre code {
    font-size: 12px;
  }
  
  /* Ajustes adicionales para móviles muy pequeños */
  .card-body {
    padding: 1rem !important;
  }
  
  .btn {
    font-size: 14px;
    padding: 10px 16px;
  }
}
</style>
<main>
  {% for post in the_post %}
  <div class="container mt-4">
    <!-- Breadcrumb -->
    <nav aria-label="Breadcrumb" class="mb-4">
      <ol class="breadcrumb bg-transparent p-0">
        <li class="breadcrumb-item"><a href="{{ url_for('index') }}" class="text-decoration-none">🏠 Inicio</a></li>
        <li class="breadcrumb-item"><a href="{{ url_for('blog') }}" class="text-decoration-none">📝 Blog</a></li>
        <li class="breadcrumb-item active text-muted">{{ post['title'][:50] }}{% if post['title']|length > 50 %}...{% endif %}</li>
      </ol>
    </nav>

    <div class="row">
      <!-- Contenido principal -->
      <div class="col-lg-8">
        <!-- Header del post -->
        <div class="card border-0 shadow-sm mb-4">
          {% if post['image'] %}
          <div class="position-relative" style="height: 300px; overflow: hidden;">
            <img src="{{ post['image'] }}" class="card-img-top w-100 h-100" style="object-fit: cover;" alt="{{ post['title'] }}" onerror="this.style.display='none'">
            <div class="position-absolute w-100 h-100" style="top: 0; background: linear-gradient(45deg, rgba(0,0,0,0.3), rgba(0,0,0,0.1));"></div>
          </div>
          {% endif %}
          <div class="card-body p-4">
            <h1 class="card-title mb-3" style="font-size: 2.2rem; font-weight: 700; line-height: 1.3; color: var(--bs-body-color);">{{ post['title'] }}</h1>
            <p class="lead text-muted mb-4" style="font-size: 1.1rem;">{{ post['descript'] }}</p>
            
            <!-- Meta información -->
            <div class="d-flex flex-wrap align-items-center mb-3 pb-3 border-bottom">
              <div class="d-flex align-items-center mr-4 mb-2">
                <div class="bg-primary rounded-circle d-flex align-items-center justify-content-center mr-2" style="width: 40px; height: 40px;">
                  <span class="text-white font-weight-bold">{{ post['creat_id'][0].upper() }}</span>
                </div>
                <div>
                  <small class="text-muted d-block">Autor</small>
                  <a href="{{ url_for('blog', autor=post['creat_id']) }}" class="text-decoration-none font-weight-medium" style="color: var(--bs-body-color);">{{ post['creat_id'] }}</a>
                </div>
              </div>
              <div class="mr-4 mb-2">
                <small class="text-muted d-block">📅 Fecha</small>
                <a href="{{ url_for('blog', time=post['time'][:10]) }}" class="text-decoration-none" style="color: var(--bs-body-color);">{{ post['time'][:10] }}</a>
              </div>
              <div class="mr-4 mb-2">
                <small class="text-muted d-block">👁️ Vistas</small>
                <span class="font-weight-medium" style="color: var(--bs-body-color);">{{ post['count_view'] }}</span>
              </div>
              <div class="mb-2">
                <small class="text-muted d-block">💬 Comentarios</small>
                <span class="font-weight-medium" style="color: var(--bs-body-color);">{{ comments|length }}</span>
              </div>
            </div>
            
            <!-- Tags -->
            {% if post['tags'] %}
            <div class="mb-3">
              <small class="text-muted d-block mb-2">🏷️ Etiquetas:</small>
              {% for tag in post['tags'] %}
                <a href="{{ url_for('blog', tags=tag) }}" class="badge badge-secondary mr-1 mb-1 text-decoration-none">{{ tag }}</a>
              {% endfor %}
            </div>
            {% endif %}
          </div>
        </div>

        <!-- Contenido del post -->
        <div class="card border-0 shadow-sm mb-4">
          <div class="card-body p-4">
            <div class="post-content" style="line-height: 1.8; font-size: 1.05rem;">
              {{ post['content'] | safe }}
            </div>
          </div>
        </div>

        <!-- Modal para previsualización de medios -->
        <div id="mediaModal" class="media-modal">
          <span class="media-modal-close">&times;</span>
          <div class="media-modal-content" id="modalContent"></div>
        </div>

        <!-- Formulario de Comentarios -->
        <div class="card border-0 shadow-sm mb-4" id="comment-form">
          <div class="card-header bg-transparent border-bottom-0 pb-0">
            <h3 class="mb-0">
              {% if comment_to_edit %}
                ✏️ Editando comentario
              {% else %}
                💬 Enviar comentario
              {% endif %}
            </h3>
          </div>
          <div class="card-body pt-3">
            {% if error %}
              <div class="alert alert-danger alert-dismissible fade show" role="alert">
                <strong>Error:</strong> {{ error }}
                <button type="button" class="close" data-dismiss="alert">
                  <span>&times;</span>
                </button>
              </div>
            {% endif %}
            {% if edit_error %}
              <div class="alert alert-danger alert-dismissible fade show" role="alert">
                <strong>Error:</strong> {{ edit_error }}
                <button type="button" class="close" data-dismiss="alert">
                  <span>&times;</span>
                </button>
              </div>
            {% endif %}

            <form method="POST" action="{{ url_for('blogview', name=post['title']) }}">
              <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
              
              {% if not sessions %}
              <div class="row">
                <div class="col-md-6">
                  <div class="form-group">
                    <label for="name" class="font-weight-medium">👤 Nombre *</label>
                    <input type="text" class="form-control" id="name" name="name" required
                           placeholder="Tu nombre"
                           value="{{ comment_to_edit.name if comment_to_edit else comment_name_default }}">
                  </div>
                </div>
                <div class="col-md-6">
                  <div class="form-group">
                    <label for="email" class="font-weight-medium">📧 Correo *</label>
                    <input type="email" class="form-control" id="email" name="email" required
                           placeholder="tu@email.com"
                           value="{{ comment_to_edit.email if comment_to_edit else comment_email_default }}">
                  </div>
                </div>
              </div>
              {% else %}
              <div class="alert alert-info border-0" style="background-color: rgba(13, 110, 253, 0.1); color: var(--bs-body-color);">
                <small>💡 Comentando como <strong style="color: var(--bs-body-color);">{{ user }}</strong></small>
              </div>
              {% endif %}

              <div class="form-group">
                <label for="message" class="font-weight-medium">💭 Mensaje *</label>
                <textarea name="message" id="message" rows="5" class="form-control" required
                          placeholder="Escribe tu comentario aquí..."
                          style="resize: vertical;">{% if comment_to_edit %}{{ comment_to_edit.message }}{% endif %}</textarea>
              </div>

              <div class="d-flex justify-content-between align-items-center">
                <div>
                  <button type="submit" class="btn btn-primary" name="comment_submit">
                    {% if comment_to_edit %}
                      ✏️ Actualizar comentario
                    {% else %}
                      💬 Publicar comentario
                    {% endif %}
                  </button>
                  {% if comment_to_edit %}
                    <a href="{{ url_for('blogview', name=post['title']) }}" class="btn btn-outline-secondary ml-2">
                      ❌ Cancelar
                    </a>
                  {% endif %}
                </div>
                <small class="text-muted">* Campos obligatorios</small>
              </div>

              {% if comment_to_edit %}
                <input type="hidden" name="comment_index_edit" value="{{ request.form.edit_comment }}">
              {% endif %}
            </form>
          </div>
        </div>

        <!-- Listado de Comentarios -->
        <div class="card border-0 shadow-sm" id="comments">
          <div class="card-header bg-transparent border-bottom-0 pb-0">
            <h3 class="mb-0">💬 Comentarios ({{ comments|length }})</h3>
          </div>
          <div class="card-body pt-3">
            {% if delete_error %}
              <div class="alert alert-danger alert-dismissible fade show" role="alert">
                <strong>Error:</strong> {{ delete_error }}
                <button type="button" class="close" data-dismiss="alert">
                  <span>&times;</span>
                </button>
              </div>
            {% endif %}
            
            {% if comments %}
              {% for comment in comments|reverse %}
                {% set comment_index = (comments|length - 1 - loop.index0) %}
                <div class="comment-item border-bottom pb-3 mb-3" {% if loop.last %}style="border-bottom: none !important; margin-bottom: 0 !important; padding-bottom: 0 !important;"{% endif %}>
                  <div class="d-flex justify-content-between align-items-start">
                    <div class="flex-grow-1">
                      <div class="d-flex align-items-center mb-2">
                        <div class="bg-secondary rounded-circle d-flex align-items-center justify-content-center mr-2" style="width: 32px; height: 32px; font-size: 14px;">
                          <span class="text-white font-weight-bold">{{ comment['name'][0].upper() }}</span>
                        </div>
                        <div>
                          <h6 class="mb-0 font-weight-bold" style="color: var(--bs-body-color);">{{ comment['name'] }}</h6>
                          <small class="text-muted">
                            📧 {{ comment['email'][:20] }}{% if comment['email']|length > 20 %}...{% endif %} • 
                            📅 {{ comment['date'][:10] }}
                          </small>
                        </div>
                      </div>
                      <p class="mb-0" style="line-height: 1.6; color: var(--bs-body-color);">{{ comment['message'] }}</p>
                    </div>
                    {% if (sessions and user == comment.get('owner')) or (not sessions and current_user_owner == comment.get('owner')) %}
                      <div class="ml-3">
                        <div class="btn-group" role="group">
                          <form method="POST" action="{{ url_for('blogview', name=post['title']) }}#comment-form" class="d-inline mr-1">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                            <input type="hidden" name="edit_comment" value="{{ comment_index }}">
                            <button type="submit" class="btn btn-outline-primary btn-sm" title="Editar comentario">
                              ✏️
                            </button>
                          </form>
                          <form method="POST" action="{{ url_for('blogview', name=post['title']) }}" class="d-inline">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                            <input type="hidden" name="delete_comment" value="{{ comment_index }}">
                            <button type="submit" class="btn btn-outline-danger btn-sm" title="Eliminar comentario" onclick="return confirm('¿Estás seguro de eliminar este comentario?')">
                              🗑️
                            </button>
                          </form>
                        </div>
                      </div>
                    {% elif sessions and user == post['creat_id'] %}
                      <div class="ml-3">
                        <form method="POST" action="{{ url_for('blogview', name=post['title']) }}" class="d-inline">
                          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                          <input type="hidden" name="delete_comment" value="{{ comment_index }}">
                          <button type="submit" class="btn btn-outline-danger btn-sm" title="Eliminar comentario" onclick="return confirm('¿Estás seguro de eliminar este comentario?')">
                            🗑️
                          </button>
                        </form>
                      </div>
                    {% endif %}
                  </div>
                </div>
              {% endfor %}
            {% else %}
              <div class="text-center py-5">
                <div class="mb-3" style="font-size: 3rem; opacity: 0.3;">💬</div>
                <h5 class="text-muted">No hay comentarios aún</h5>
                <p class="text-muted">Sé el primero en comentar este artículo</p>
              </div>
            {% endif %}
          </div>
        </div>
        </div>

      <!-- Columna lateral -->
      <div class="col-lg-4">
        <!-- Acciones del autor -->
        {% if user == post['creat_id'] %}
        <div class="card border-0 shadow-sm mb-4">
          <div class="card-header bg-transparent border-bottom pb-2">
            <h5 class="mb-0" style="color: var(--bs-body-color);">⚙️ Gestionar Post</h5>
          </div>
          <div class="card-body pt-3">
            <a href="{{ url_for('blogedit', post_id=post['id']) }}" class="btn btn-outline-primary btn-block mb-2">
              ✏️ Editar Post
            </a>
            <a href="{{ url_for('blogdelete', post_id=post['id']) }}" class="btn btn-outline-danger btn-block" onclick="return confirm('¿Estás seguro de eliminar este post?')">
              🗑️ Eliminar Post
            </a>
          </div>
        </div>
        {% endif %}

        <!-- Búsqueda -->
        <div class="card border-0 shadow-sm mb-4">
          <div class="card-header bg-transparent border-bottom pb-2">
            <h5 class="mb-0" style="color: var(--bs-body-color);">🔍 Buscar</h5>
          </div>
          <div class="card-body pt-3">
            <form action="{{ url_for('blog') }}" method="GET">
              <div class="input-group">
                <input type="text" class="form-control" placeholder="Buscar posts..." name="search">
                <div class="input-group-append">
                  <button type="submit" class="btn btn-primary">
                    🔍
                  </button>
                </div>
              </div>
            </form>
          </div>
        </div>

        <!-- Posts recientes -->
        <div class="card border-0 shadow-sm mb-4">
          <div class="card-header bg-transparent border-bottom pb-2">
            <h5 class="mb-0" style="color: var(--bs-body-color);">📚 Posts Recientes</h5>
          </div>
          <div class="card-body pt-3">
            {% for rpost in recent %}
            <div class="d-flex mb-3 pb-3 {% if not loop.last %}border-bottom{% endif %}" style="transition: background-color 0.2s;" onmouseover="this.style.backgroundColor='rgba(0,0,0,0.05)'" onmouseout="this.style.backgroundColor='transparent'">
              <div class="flex-shrink-0 mr-3">
                <a href="{{ url_for('blogview', name=rpost['title']) }}">
                  <img src="{{ rpost['image'] if rpost['image'] else url_for('static', filename='blog/default.png') }}"
                       class="rounded shadow-sm" style="width: 65px; height: 65px; object-fit: cover; transition: transform 0.2s;"
                       alt="{{ rpost['title'] }}"
                       onerror="this.onerror=null; this.src='{{ url_for('static', filename='blog/default.png') }}'"
                       onmouseover="this.style.transform='scale(1.05)'"
                       onmouseout="this.style.transform='scale(1)'">
                </a>
              </div>
              <div class="flex-grow-1">
                <h6 class="mb-2 font-weight-bold">
                  <a href="{{ url_for('blogview', name=rpost['title']) }}" class="text-decoration-none" style="color: var(--bs-body-color); line-height: 1.3;">
                    {{ rpost['title'][:45] }}{% if rpost['title']|length > 45 %}...{% endif %}
                  </a>
                </h6>
                <div class="d-flex justify-content-between align-items-center">
                  <small class="text-muted">
                    📅 {{ rpost['time'][:10] }}<br>
                    👤 <span style="color: var(--bs-body-color); font-weight: 500;">{{ rpost['creat_id'] }}</span>
                  </small>
                  <small class="badge badge-light">👁️ {{ rpost['count_view'] or 0 }}</small>
                </div>
              </div>
            </div>
            {% endfor %}
            <div class="text-center">
              <a href="{{ url_for('blog') }}" class="btn btn-outline-primary btn-sm">
                📚 Ver todos los posts
              </a>
            </div>
          </div>
        </div>

        <!-- Navegación rápida -->
        <div class="card border-0 shadow-sm">
          <div class="card-header bg-transparent border-bottom pb-2">
            <h5 class="mb-0" style="color: var(--bs-body-color);">🧭 Navegación</h5>
          </div>
          <div class="card-body pt-3">
            <div class="d-flex flex-column gap-2">
              <a href="{{ url_for('blog') }}" class="btn btn-outline-secondary btn-sm mb-2">
                📝 Todos los posts
              </a>
              <a href="{{ url_for('blog', autor=post['creat_id']) }}" class="btn btn-outline-secondary btn-sm mb-2">
                👤 Posts de {{ post['creat_id'] }}
              </a>
              {% if post['tags'] %}
              <a href="{{ url_for('blog', tags=post['tags'][0]) }}" class="btn btn-outline-secondary btn-sm">
                🏷️ Más con "{{ post['tags'][0] }}"
              </a>
              {% endif %}
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  {% endfor %}
</main>
{% endblock %}

{% block scripts %}
<script>
// Detección y resaltado de sintaxis automático
function initSyntaxHighlighting() {
  const codeBlocks = document.querySelectorAll('.post-content pre code');
  
  codeBlocks.forEach(function(block) {
    // Detectar lenguaje por contenido
    const code = block.textContent;
    const language = detectLanguage(code);
    
    // Aplicar resaltado básico
    if (language) {
      block.innerHTML = highlightCode(code, language);
      
      // Añadir indicador de lenguaje
      const pre = block.parentElement;
      if (!pre.querySelector('.language-indicator')) {
        const indicator = document.createElement('div');
        indicator.className = 'language-indicator';
        indicator.textContent = language.toUpperCase();
        indicator.style.cssText = `
          position: absolute;
          top: 12px;
          right: 16px;
          font-size: 11px;
          color: #8b949e;
          background: rgba(0,0,0,0.3);
          padding: 4px 8px;
          border-radius: 4px;
          font-weight: 600;
          backdrop-filter: blur(4px);
          border: 1px solid rgba(255,255,255,0.1);
        `;
        pre.appendChild(indicator);
      }
    }
  });
}

function detectLanguage(code) {
  // Patrones para detectar lenguajes
  const patterns = {
    javascript: /\b(function|const|let|var|=>|console\.log|document\.|window\.)\b/,
    python: /\b(def|import|from|print|if __name__|class|self)\b/,
    java: /\b(public class|private|protected|public static void main)\b/,
    html: /<\/?[a-z][\s\S]*>/i,
    css: /\{[^}]*\}|@media|@import/,
    sql: /\b(SELECT|FROM|WHERE|INSERT|UPDATE|DELETE|CREATE|ALTER)\b/i,
    json: /^\s*[{\[].*[}\]]\s*$/s,
    bash: /\b(echo|ls|cd|mkdir|chmod|sudo|grep)\b/,
    php: /<\?php|\$\w+/,
    c: /\b(#include|int main|printf|scanf)\b/,
    cpp: /\b(#include|using namespace|cout|cin)\b/
  };
  
  for (const [lang, pattern] of Object.entries(patterns)) {
    if (pattern.test(code)) {
      return lang;
    }
  }
  return null;
}

function highlightCode(code, language) {
  let highlighted = code;
  
  // Patrones de resaltado por lenguaje
  const syntaxPatterns = {
    javascript: {
      keyword: /\b(function|const|let|var|if|else|for|while|return|class|extends|import|export|from|default|async|await|try|catch|finally|throw|new|this|super|static|get|set)\b/g,
      string: /(['"`])(?:(?!\1)[^\\]|\\.)*\1/g,
      comment: /\/\/.*$|\/\*[\s\S]*?\*\//gm,
      number: /\b\d+(\.\d+)?\b/g,
      function: /\b\w+(?=\s*\()/g
    },
    python: {
      keyword: /\b(def|class|if|elif|else|for|while|return|import|from|as|try|except|finally|with|lambda|and|or|not|in|is|True|False|None)\b/g,
      string: /(['"])(?:(?!\1)[^\\]|\\.)*\1|'''[\s\S]*?'''|"""|[\s\S]*?"""/g,
      comment: /#.*$/gm,
      number: /\b\d+(\.\d+)?\b/g,
      function: /\bdef\s+(\w+)/g
    },
    html: {
      tag: /<\/?[a-zA-Z][^>]*>/g,
      attribute: /\s([a-zA-Z-]+)=/g,
      value: /=(['"]).*?\1/g,
      comment: /<!--[\s\S]*?-->/g
    },
    css: {
      property: /([a-zA-Z-]+)\s*:/g,
      value: /:([^;{}]+);/g,
      comment: /\/\*[\s\S]*?\*\//g,
      selector: /[^{}]+(?=\s*\{)/g
    }
  };
  
  const patterns = syntaxPatterns[language] || syntaxPatterns.javascript;
  
  // Aplicar resaltado
  Object.entries(patterns).forEach(([type, pattern]) => {
    highlighted = highlighted.replace(pattern, (match) => {
      return `<span class="${type}">${match}</span>`;
    });
  });
  
  return highlighted;
}

// Previsualización de medios
function initMediaPreview() {
  const modal = document.getElementById('mediaModal');
  const modalContent = document.getElementById('modalContent');
  const closeBtn = document.querySelector('.media-modal-close');
  
  // Hacer imágenes y videos clickeables
  document.querySelectorAll('.post-content img, .post-content video').forEach(media => {
    media.addEventListener('click', function() {
      const clone = this.cloneNode(true);
      clone.style.cursor = 'default';
      clone.style.transform = 'none';
      modalContent.innerHTML = '';
      modalContent.appendChild(clone);
      modal.style.display = 'block';
      document.body.style.overflow = 'hidden';
    });
  });
  
  // Cerrar modal
  closeBtn.addEventListener('click', closeModal);
  modal.addEventListener('click', function(e) {
    if (e.target === modal) closeModal();
  });
  
  document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') closeModal();
  });
  
  function closeModal() {
    modal.style.display = 'none';
    document.body.style.overflow = 'auto';
  }
}

// Inicializar todo
document.addEventListener('DOMContentLoaded', function() {
  initSyntaxHighlighting();
  initMediaPreview();
});
</script>
{% endblock %}
